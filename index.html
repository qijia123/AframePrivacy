<!DOCTYPE html>
<html>
  <head>
    <title>VR Experiment - Cube Moving with Joystick Movement and Rotation</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/wmurphyrd/aframe-super-hands-component@latest/dist/aframe-super-hands.min.js"></script>
    <script>
      // Ensure THREE.Geometry is defined
      if (typeof THREE !== 'undefined') {
          THREE.Geometry = class Geometry {
             constructor() {
                this.vertices = [];
                this.faces = [];
            }
            fromBufferGeometry(bufferGeometry) {
                const positionAttribute = bufferGeometry.getAttribute('position');
                this.vertices = [];
                for (let i = 0; i < positionAttribute.count; i++) {
                    this.vertices.push(new THREE.Vector3().fromBufferAttribute(positionAttribute, i));
                }
                return this;
            }
        };
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.compat.js"></script>
    <style>
        .a-enter-vr-button {
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 9999;
      
          /* Make the button large and fully opaque */
          font-size: 3em;              /* Scales up everything */
          padding: 15px 30px !important;          /* More space around text */
          background-color: #fff !important;
          color: #000 !important;
          opacity: 1 !important;
          border: none !important;
          border-radius: 10px;
          box-shadow: none !important;
      
          /* Center any custom text we insert */
          display: flex;
          align-items: center;
          justify-content: center;
        }
      
        /* Hide the default A-Frame VR icon (an SVG) */
        .a-enter-vr-button svg {
          display: none !important;
        }
      
        /* Inject custom text (instead of the hidden icon) */
        .a-enter-vr-button::after {
          content: 'Enter VR';    /* The text you want displayed */
          color: #000;
          font-size: 2em;         /* 1em here = 3em overall (from parent) */
          line-height: 1;
          text-align: center;
        }
    </style>          
  </head>
  <body>
    <a-scene physics="debug: true; gravity: -9.8" id="scene">
      <a-entity id="rig" position="0 1.6 0" joystick-movement="speed: 1.5">
        <a-camera></a-camera>
        <a-entity 
          id="leftHand" 
          hand-controls="hand: left; handModelStyle: lowPoly" 
          kinematic-body 
          super-hands>
        </a-entity>
        <a-entity 
         id="rightHand" 
         hand-controls="hand: right; handModelStyle: lowPoly" 
         kinematic-body 
         sphere-collider="objects: .grabbable, .hoverable; radius: 0.5; debug: true" 
         super-hands="colliderEvent: collisions; colliderEventProperty: els; 
         stretchable: true; maxDistance: 1.0"
         joystick-rotation="speed: 60">
      </a-entity>
    

      <a-plane static-body position="0 0 -4" rotation="-90 0 0" width="20" height="20" color="#7BC8A4"></a-plane>
      <a-sky color="#ECECEC"></a-sky>

      <a-entity id="uiPanel" position="0 2.5 -1.5">
        <a-plane width="2" height="1" color="#333" opacity="0.7"></a-plane>
        <a-text id="uiText" value="" align="center" position="0 0 0.1" width="1.8"></a-text>
      </a-entity>
    </a-scene>

    <script>
      // Joystick movement component: moves the rig based on thumbstick input on the left controller.
      AFRAME.registerComponent("joystick-movement", {
        schema: { speed: { type: "number", default: 1.5 } },
        init() {
          this.joystick = { x: 0, y: 0 };
          document.querySelector("#leftHand").addEventListener("thumbstickmoved", evt => {
            this.joystick = { x: evt.detail.x, y: evt.detail.y };
          });
        },
        tick(time, deltaTime) {
          const dt = deltaTime / 1000;
          const rigEl = this.el;
          const rigRotation = rigEl.getAttribute("rotation").y;
          const inputVector = new THREE.Vector3(this.joystick.x, 0, this.joystick.y);
          const quat = new THREE.Quaternion().setFromAxisAngle(
            new THREE.Vector3(0, 1, 0),
            THREE.MathUtils.degToRad(rigRotation)
          );
          inputVector.applyQuaternion(quat).multiplyScalar(this.data.speed * dt);
          rigEl.object3D.position.add(inputVector);
        }
      });

      // Joystick rotation component: rotates the rig based on thumbstick input on the right controller.
      AFRAME.registerComponent("joystick-rotation", {
        schema: { speed: { type: "number", default: 45 } },
        init() {
          this.rotationInput = 0;
          this.el.addEventListener("thumbstickmoved", evt => {
            this.rotationInput = evt.detail.x;
          });
        },
        tick(time, deltaTime) {
          const dt = deltaTime / 1000;
          const rigEl = document.querySelector("#rig");
          let currentRotation = rigEl.getAttribute("rotation");
          currentRotation.y += this.rotationInput * this.data.speed * dt;
          rigEl.setAttribute("rotation", currentRotation);
        }
      });

      // Disable physics when an object is grabbed.
      AFRAME.registerComponent("disable-physics-on-grab", {
        init() {
          this.el.addEventListener("grab-start", () => {
            this.el.removeAttribute("dynamic-body");
            this.el.setAttribute("static-body", ""); // Prevent falling during grab
          });
          this.el.addEventListener("grab-end", () => {
            this.el.removeAttribute("static-body");
            this.el.setAttribute("dynamic-body", "shape: box; mass: 2");
          });
        }
      });

      // Experiment state machine constants and variables.
      const STATES = {
        WELCOME: "WELCOME",
        CALIBRATE: "CALIBRATE",
        MOVINGOBJECT: "MOVINGOBJECT",
        FINISH: "FINISH"
      };
      let experimentState = STATES.WELCOME,
          trialCounter = 0,
          totalTrials = 5,
          currentCube = null,
          currentTarget = null,
          cubeInitialPosition = null,
          cubeGrabbed = false;

      function updateUIText(text) {
        document.querySelector("#uiText").setAttribute("value", text);
      }

      function enterState(state) {
        experimentState = state;
        switch (state) {
          case STATES.WELCOME:
            updateUIText(
              "Welcome!\nUse your right controller grip to pick up a cube and move it to the red target area.\nDo this 5 times.\nPress the right controller grip to continue."
            );
            break;
          case STATES.CALIBRATE:
            updateUIText("Calibrate:\nHold your right controller against your chest and press the trigger.");
            break;
          case STATES.MOVINGOBJECT:
            updateUIText(`Trial ${trialCounter + 1}:\nGrab the green cube and move it to the red target area.\nRelease the grip to drop it.`);
            startCubeTrial();
            break;
          case STATES.FINISH:
            updateUIText("Task completed!\nThank you for participating.");
            break;
        }
      }

      // Create and start a trial by adding a cube and a target to the scene.
      function startCubeTrial() {
        const sceneEl = document.querySelector("a-scene");
        
        // Create the cube.
        currentCube = document.createElement("a-box");
        currentCube.setAttribute("color", "green");
        currentCube.setAttribute("depth", "0.2");
        currentCube.setAttribute("height", "0.2");
        currentCube.setAttribute("width", "0.2");
        currentCube.setAttribute("dynamic-body", "shape: box;");
        currentCube.setAttribute("grabbable", "stretchable: true; constrainToLocal: true");
        currentCube.setAttribute("disable-physics-on-grab", "");
        currentCube.classList.add("grabbable", "hoverable"); // Correct class names
       
        currentCube.setAttribute("position", "0 2.6 -0.5");

        currentCube.addEventListener("grab-start", () => {
          console.log("Grab started");
          console.log("Grab started at position:", currentCube.object3D.position);
          console.log("Right hand position:", document.querySelector("#rightHand").object3D.position);
        });
        currentCube.addEventListener("grab-end", () => {
          console.log("Grab ended. Cube position:", currentCube.object3D.position);
        });
        
        sceneEl.appendChild(currentCube);

        // Update the sphere collider on the right hand.
        const rightHandEl = document.querySelector("#rightHand");
        console.log("Super-hands component:", rightHandEl.components['super-hands']);
        console.log("Right hand components:", rightHandEl.components);
        rightHandEl.addEventListener('abuttondown', () => console.log('A pressed'));
        rightHandEl.addEventListener('bbuttondown', () => console.log('B pressed'));
        if (rightHandEl.components["sphere-collider"]) {
            rightHandEl.components["sphere-collider"].update();
        }
        // Create the target.
        currentTarget = document.createElement("a-box");
        currentTarget.setAttribute("color", "red");
        currentTarget.setAttribute("depth", "0.15");
        currentTarget.setAttribute("height", "0.15");
        currentTarget.setAttribute("width", "0.15");
        currentTarget.setAttribute("position", "0.5 2.6 -0.5");
        currentTarget.setAttribute("material", "opacity: 0.3; transparent: true; wireframe: true;");
        sceneEl.appendChild(currentTarget);

        cubeInitialPosition = new THREE.Vector3(0, 2.6, -0.5);
        cubeGrabbed = false;
      }
      

      // Trial checker component: monitors the cube position and checks if the trial is completed.
      AFRAME.registerComponent("trial-checker", {
        tick() {
          if (experimentState === STATES.MOVINGOBJECT && currentCube && currentTarget) {
            const cubePos = new THREE.Vector3();
            currentCube.object3D.getWorldPosition(cubePos);
            if (!cubeGrabbed && cubePos.distanceTo(cubeInitialPosition) > 0.05) {
              cubeGrabbed = true;
            }
            if (cubeGrabbed) {
              const targetPos = new THREE.Vector3();
              currentTarget.object3D.getWorldPosition(targetPos);
              if (cubePos.distanceTo(targetPos) < 0.15) {
                trialCounter++;
                currentCube.remove();
                currentTarget.remove();
                currentCube = currentTarget = null;
                cubeGrabbed = false;
                setTimeout(() => {
                  enterState(trialCounter < totalTrials ? STATES.MOVINGOBJECT : STATES.FINISH);
                }, 500);
              }
            }
          }
        }
      });

      // Activate the trial checker.
      document.querySelector("a-scene").setAttribute("trial-checker", "");

      // Controller event listeners to transition between states.
      const rightHandEl = document.querySelector("#rightHand");
      rightHandEl.addEventListener("gripdown", () => {
        if (experimentState === STATES.WELCOME) {
          console.log("Right controller grip pressed. Advancing to CALIBRATE.");
          enterState(STATES.CALIBRATE);
        }
      });
      rightHandEl.addEventListener("triggerdown", () => {
        if (experimentState === STATES.CALIBRATE) {
          console.log("Right controller trigger pressed. Calibrating and advancing to MOVINGOBJECT.");
          document.querySelector("#rig").setAttribute("position", "0 1.6 0");
          enterState(STATES.MOVINGOBJECT);
        }
      });

      // Start with the welcome state.
      enterState(STATES.WELCOME);
    </script>
  </body>
</html>