<!DOCTYPE html>
<html>
  <head>
    <title>VR Experiment - Cube Moving with Joystick Movement and Rotation</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/super-hands@4.0.5/dist/super-hands.min.js"></script>
  </head>
  <body>
    <a-scene physics="debug: false; gravity: -9.8" id="scene">
      <!-- Camera Rig -->
      <a-entity id="rig" position="0 1.6 0" joystick-movement="speed: 1.5">
        <a-camera></a-camera>
        <!-- Left Hand -->
        <a-entity 
          id="leftHand"
          hand-controls="hand: left;"
          kinematic-body
          super-hands
        ></a-entity>
        <!-- Right Hand -->
        <a-entity 
          id="rightHand"
          hand-controls="hand: right;"
          kinematic-body
          sphere-collider="objects: .grabbable; radius: 0.3"
          super-hands
          joystick-rotation="speed: 45"
        ></a-entity>
      </a-entity>

      <!-- Environment -->
      <a-plane static-body position="0 0 -4" rotation="-90 0 0" width="20" height="20" color="#7BC8A4"></a-plane>
      <a-sky color="#ECECEC"></a-sky>

      <!-- UI -->
      <a-entity id="uiPanel" position="0 2.5 -1.5">
        <a-plane width="2" height="1" color="#333" opacity="0.7"></a-plane>
        <a-text id="uiText" value="" align="center" position="0 0 0.1" width="1.8"></a-text>
      </a-entity>
    </a-scene>

    <script>
      // Movement Component
      AFRAME.registerComponent("joystick-movement", {
        schema: { speed: { type: "number", default: 1.5 } },
        init: function () {
          this.joystick = { x: 0, y: 0 };
          document.querySelector("#leftHand").addEventListener("thumbstickmoved", (evt) => {
            this.joystick.x = evt.detail.x;
            this.joystick.y = evt.detail.y;
          });
        },
        tick: function (time, deltaTime) {
          const dt = deltaTime / 1000;
          const rigEl = this.el;
          const inputVector = new THREE.Vector3(this.joystick.x, 0, this.joystick.y);
          const rigRotation = rigEl.getAttribute("rotation").y;
          const quat = new THREE.Quaternion().setFromAxisAngle(
            new THREE.Vector3(0, 1, 0),
            THREE.MathUtils.degToRad(rigRotation)
          );
          inputVector.applyQuaternion(quat).multiplyScalar(this.data.speed * dt);
          rigEl.object3D.position.add(inputVector);
        }
      });

      // Rotation Component
      AFRAME.registerComponent("joystick-rotation", {
        schema: { speed: { type: "number", default: 45 } },
        init: function () {
          this.rotationInput = 0;
          this.el.addEventListener("thumbstickmoved", (evt) => {
            this.rotationInput = evt.detail.x;
          });
        },
        tick: function (time, deltaTime) {
          const dt = deltaTime / 1000;
          const rigEl = document.querySelector("#rig");
          const currentRotation = rigEl.getAttribute("rotation");
          currentRotation.y += this.rotationInput * this.data.speed * dt;
          rigEl.setAttribute("rotation", currentRotation);
        }
      });

      // Physics Toggle Component (Updated)
      AFRAME.registerComponent("disable-physics-on-grab", {
        init: function () {
          this.el.addEventListener("grab-start", () => {
            this.el.setAttribute("dynamic-body", "type: kinematic; mass: 0.5; shape: box");
          });
          this.el.addEventListener("grab-end", () => {
            this.el.setAttribute("dynamic-body", "type: dynamic; mass: 0.5; shape: box");
          });
        }
      });

      // Experiment State Machine
      const STATES = {
        WELCOME: "WELCOME",
        CALIBRATE: "CALIBRATE",
        MOVINGOBJECT: "MOVINGOBJECT",
        FINISH: "FINISH"
      };

      let experimentState = STATES.WELCOME;
      let trialCounter = 0;
      const totalTrials = 5;
      let currentCube = null;
      let currentTarget = null;
      let cubeInitialPosition = null;
      let cubeGrabbed = false;

      function updateUIText(text) {
        document.querySelector("#uiText").setAttribute("value", text);
      }

      function enterState(state) {
        experimentState = state;
        switch (state) {
          case STATES.WELCOME:
            updateUIText(
              "Welcome!\nUse right grip to pick up cubes\nRight trigger to calibrate\n5 trials total"
            );
            break;
          case STATES.CALIBRATE:
            updateUIText("Hold right controller at chest height\nPress trigger to calibrate");
            break;
          case STATES.MOVINGOBJECT:
            updateUIText(`Trial ${trialCounter + 1}/${totalTrials}\nGrab cube â†’ Red target`);
            startCubeTrial();
            break;
          case STATES.FINISH:
            updateUIText("Experiment Complete!\nThank you!");
            break;
        }
      }

      function startCubeTrial() {
        const sceneEl = document.querySelector("a-scene");
        
        // Create Cube
        currentCube = document.createElement("a-box");
        currentCube.setAttribute("color", "#4CC3D9");
        currentCube.setAttribute("width", "0.3");
        currentCube.setAttribute("height", "0.3");
        currentCube.setAttribute("depth", "0.3");
        currentCube.setAttribute("position", "0 1.5 -1");
        currentCube.setAttribute("dynamic-body", "shape: box; mass: 0.5");
        currentCube.setAttribute("grabbable", "");
        currentCube.setAttribute("disable-physics-on-grab", "");
        currentCube.classList.add("grabbable");
        sceneEl.appendChild(currentCube);

        // Create Target
        currentTarget = document.createElement("a-ring");
        currentTarget.setAttribute("color", "red");
        currentTarget.setAttribute("radius-inner", "0.2");
        currentTarget.setAttribute("radius-outer", "0.3");
        currentTarget.setAttribute("position", "1 1.5 -1");
        currentTarget.setAttribute("rotation", "-90 0 0");
        sceneEl.appendChild(currentTarget);

        cubeInitialPosition = new THREE.Vector3(0, 1.5, -1);
        cubeGrabbed = false;
      }

      // Trial Checker Component
      AFRAME.registerComponent("trial-checker", {
        tick: function () {
          if (experimentState === STATES.MOVINGOBJECT && currentCube && currentTarget) {
            const cubePos = new THREE.Vector3();
            currentCube.object3D.getWorldPosition(cubePos);
            
            if (!cubeGrabbed && cubePos.distanceTo(cubeInitialPosition) > 0.05) {
              cubeGrabbed = true;
            }

            if (cubeGrabbed) {
              const targetPos = new THREE.Vector3();
              currentTarget.object3D.getWorldPosition(targetPos);
              
              if (cubePos.distanceTo(targetPos) < 0.3) {
                trialCounter++;
                currentCube.parentNode?.removeChild(currentCube);
                currentTarget.parentNode?.removeChild(currentTarget);
                currentCube = null;
                currentTarget = null;
                cubeGrabbed = false;

                trialCounter < totalTrials 
                  ? setTimeout(() => enterState(STATES.MOVINGOBJECT), 500)
                  : enterState(STATES.FINISH);
              }
            }
          }
        }
      });
      document.querySelector("a-scene").setAttribute("trial-checker", "");

      // Event Listeners
      document.querySelector("#rightHand").addEventListener("gripdown", () => {
        if (experimentState === STATES.WELCOME) enterState(STATES.CALIBRATE);
      });

      document.querySelector("#rightHand").addEventListener("triggerdown", () => {
        if (experimentState === STATES.CALIBRATE) {
          document.querySelector("#rig").setAttribute("position", "0 1.6 0");
          enterState(STATES.MOVINGOBJECT);
        }
      });

      // Initialize
      enterState(STATES.WELCOME);
    </script>
  </body>
</html>
